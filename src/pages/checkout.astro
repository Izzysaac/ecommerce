---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Checkout">
	<main class="checkout">
		<h1>Checkout</h1>

		<section id="emptyState" class="empty" hidden>
			<p>Tu carrito est√° vac√≠o.</p>
			<a class="btn" href="/catalog">Volver al cat√°logo</a>
		</section>

		<section id="checkoutContent" class="content" hidden>
			<div class="grid">
				<section class="order">
					<h2>Resumen del pedido</h2>
					<div id="orderItems" class="items"></div>
					<div class="total">
						<span>Total</span>
						<strong id="orderTotal">$0</strong>
					</div>
				</section>

				<section class="customer">
					<h2>Datos del cliente</h2>
					<form id="customerForm" novalidate>
						<label class="field">
							<span>Nombre completo</span>
							<input id="customerName" name="name" type="text" autocomplete="name" required />
							<small class="error" data-for="name" aria-live="polite"></small>
						</label>

						<label class="field">
							<span>Tel√©fono</span>
							<input id="customerPhone" name="phone" type="tel" inputmode="tel" autocomplete="tel" required />
							<small class="error" data-for="phone" aria-live="polite"></small>
						</label>

						<label class="field">
							<span>Direcci√≥n completa</span>
							<textarea id="customerAddress" name="address" rows="4" autocomplete="street-address" required></textarea>
							<small class="error" data-for="address" aria-live="polite"></small>
						</label>

						<div class="actions">
							<button id="whatsappBtn" type="button" class="btn primary" disabled>
								Pedir por WhatsApp
							</button>
							<p id="formHint" class="hint" aria-live="polite"></p>
						</div>
					</form>
				</section>
			</div>
		</section>
	</main>

	<script>
		(() => {
			const STORAGE_KEY = "cart";
			const WHATSAPP_PHONE = "573163896572";

			const elEmpty = document.getElementById("emptyState");
			const elContent = document.getElementById("checkoutContent");
			const elItems = document.getElementById("orderItems");
			const elTotal = document.getElementById("orderTotal");
			const elBtn = document.getElementById("whatsappBtn");
			const elHint = document.getElementById("formHint");

			const elName = document.getElementById("customerName");
			const elPhone = document.getElementById("customerPhone");
			const elAddress = document.getElementById("customerAddress");

			if (!elEmpty || !elContent || !elItems || !elTotal || !elBtn || !elHint || !elName || !elPhone || !elAddress) {
				return;
			}

			const emptyStateEl = elEmpty;
			const contentEl = elContent;
			const itemsEl = elItems;
			const totalEl = elTotal;
			const whatsappBtn = /** @type {HTMLButtonElement} */ (elBtn);
			const hintEl = elHint;

			const nameInput = elName;
			const phoneInput = elPhone;
			const addressInput = elAddress;

			const formatPrice = (value) => {
				try {
					return new Intl.NumberFormat("es-CO", {
						style: "currency",
						currency: "COP",
						maximumFractionDigits: 0,
					}).format(Number(value) || 0);
				} catch {
					return `$${Math.round(Number(value) || 0).toLocaleString("es-CO")}`;
				}
			};

			const escapeHtml = (s) =>
				String(s)
					.replace(/&/g, "&amp;")
					.replace(/</g, "&lt;")
					.replace(/>/g, "&gt;")
					.replace(/\"/g, "&quot;")
					.replace(/'/g, "&#039;");

			const sanitizeText = (s) => {
				return String(s ?? "")
					.replace(/\s+/g, " ")
					.trim();
			};

			const parseCart = () => {
				const raw = localStorage.getItem(STORAGE_KEY);
				if (!raw) return { items: [] };
				try {
					const parsed = JSON.parse(raw);
					if (!parsed || typeof parsed !== "object") return { items: [] };
					if (!Array.isArray(parsed.items)) return { items: [] };
					const items = parsed.items
						.filter((i) => i && typeof i === "object")
						.map((i) => ({
							id: String(i.id ?? ""),
							title: String(i.title ?? ""),
							price: Number(i.price ?? 0),
							quantity: Math.max(1, Number(i.quantity ?? 1)),
						}))
						.filter((i) => i.id);
					return { items };
				} catch {
					return { items: [] };
				}
			};

			const computeTotal = (items) =>
				items.reduce((acc, it) => acc + (Number(it.price) || 0) * (Number(it.quantity) || 0), 0);

			const renderOrder = () => {
				const { items } = parseCart();
				if (!items.length) {
					emptyStateEl.hidden = false;
					contentEl.hidden = true;
					whatsappBtn.disabled = true;
					return;
				}

				emptyStateEl.hidden = true;
				contentEl.hidden = false;

				const total = computeTotal(items);
				totalEl.textContent = formatPrice(total);

				itemsEl.innerHTML = `
					<div class="row header">
						<span>Producto</span>
						<span class="right">Precio</span>
						<span class="right">Cant.</span>
						<span class="right">Subtotal</span>
					</div>
					${items
						.map((it) => {
							const subtotal = (Number(it.price) || 0) * (Number(it.quantity) || 0);
							return `
								<div class="row">
									<span class="name">${escapeHtml(it.title)}</span>
									<span class="right">${escapeHtml(formatPrice(it.price))}</span>
									<span class="right">${escapeHtml(it.quantity)}</span>
									<span class="right">${escapeHtml(formatPrice(subtotal))}</span>
								</div>
							`;
						})
						.join("")}
				`;
			};

			const setError = (field, msg) => {
				const el = document.querySelector(`.error[data-for="${field}"]`);
				if (el) el.textContent = msg || "";
			};

			const clearErrors = () => {
				setError("name", "");
				setError("phone", "");
				setError("address", "");
			};

			const getCustomerData = () => {
				const name = sanitizeText((nameInput instanceof HTMLInputElement ? nameInput.value : ""));
				const phone = sanitizeText((phoneInput instanceof HTMLInputElement ? phoneInput.value : ""));
				const address = sanitizeText((addressInput instanceof HTMLTextAreaElement ? addressInput.value : ""));
				return { name, phone, address };
			};

			const validate = () => {
				clearErrors();
				hintEl.textContent = "";

				const { items } = parseCart();
				if (!items.length) {
					whatsappBtn.disabled = true;
					hintEl.textContent = "Agrega productos al carrito para continuar.";
					return false;
				}

				const { name, phone, address } = getCustomerData();
				let ok = true;

				if (!name) {
					setError("name", "Ingresa tu nombre completo.");
					ok = false;
				}
				if (!phone) {
					setError("phone", "Ingresa tu tel√©fono.");
					ok = false;
				}
				if (!address) {
					setError("address", "Ingresa tu direcci√≥n.");
					ok = false;
				}

				whatsappBtn.disabled = !ok;
				if (!ok) hintEl.textContent = "Completa los campos requeridos.";
				return ok;
			};

			const buildMessage = () => {
				const { items } = parseCart();
				const { name, phone, address } = getCustomerData();

				const lines = [];
				lines.push("üõí NUEVO PEDIDO");
				lines.push("");
				lines.push(`üë§ Nombre: ${name}`);
				lines.push(`üìû Tel√©fono: ${phone}`);
				lines.push(`üìç Direcci√≥n: ${address}`);
				lines.push("");
				lines.push("üì¶ Productos:");

				items.forEach((it) => {
					const subtotal = (Number(it.price) || 0) * (Number(it.quantity) || 0);
					lines.push(`- ${sanitizeText(it.title)} x${Number(it.quantity) || 0} - ${formatPrice(subtotal)}`);
				});

				lines.push("");
				lines.push(`üí∞ Total: ${formatPrice(computeTotal(items))}`);

				return lines.join("\n");
			};

			const openWhatsApp = () => {
				if (!validate()) return;

				const msg = buildMessage();
				const url = `https://wa.me/${WHATSAPP_PHONE}?text=${encodeURIComponent(msg)}`;

				try {
					window.location.href = url;
				} catch {
					window.open(url, "_blank", "noopener,noreferrer");
				}

				// Opcional: limpiar carrito despu√©s de redirigir
				// localStorage.setItem(STORAGE_KEY, JSON.stringify({ items: [], updatedAt: Date.now() }));
			};

			nameInput.addEventListener("input", validate);
			phoneInput.addEventListener("input", validate);
			addressInput.addEventListener("input", validate);
			whatsappBtn.addEventListener("click", openWhatsApp);

			window.addEventListener("storage", (e) => {
				if (e.key === STORAGE_KEY) {
					renderOrder();
					validate();
				}
			});

			renderOrder();
			validate();
		})();
	</script>

	<style>
		.checkout {
			max-width: 1100px;
			margin: 0 auto;
			padding: 24px 16px 48px;
		}

		.checkout h1 {
			margin: 0 0 16px;
			font-size: 28px;
		}

		.grid {
			display: grid;
			grid-template-columns: 1.2fr 0.8fr;
			gap: 18px;
			align-items: start;
		}

		@media (max-width: 900px) {
			.grid {
				grid-template-columns: 1fr;
			}
		}

		.order,
		.customer {
			border: 1px solid rgba(0, 0, 0, 0.12);
			border-radius: 12px;
			padding: 16px;
			background: white;
		}

		.items {
			display: flex;
			flex-direction: column;
			gap: 8px;
			margin-top: 12px;
		}

		.row {
			display: grid;
			grid-template-columns: 1.4fr 0.6fr 0.4fr 0.6fr;
			gap: 10px;
			padding: 10px 8px;
			border-radius: 10px;
		}

		.row.header {
			background: rgba(0, 0, 0, 0.04);
			font-weight: 600;
		}

		.row:not(.header) {
			border: 1px solid rgba(0, 0, 0, 0.08);
		}

		.row .right {
			text-align: right;
		}

		.total {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-top: 12px;
			padding-top: 12px;
			border-top: 1px solid rgba(0, 0, 0, 0.12);
			font-size: 18px;
		}

		.field {
			display: flex;
			flex-direction: column;
			gap: 6px;
			margin-top: 12px;
		}

		.field input,
		.field textarea {
			padding: 10px 12px;
			border-radius: 10px;
			border: 1px solid rgba(0, 0, 0, 0.18);
			outline: none;
			font: inherit;
			background: white;
		}

		.field input:focus,
		.field textarea:focus {
			border-color: rgba(0, 0, 0, 0.45);
		}

		.error {
			min-height: 16px;
			color: #b00020;
			font-size: 12px;
		}

		.actions {
			margin-top: 14px;
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		.btn {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
			padding: 10px 14px;
			border-radius: 10px;
			border: 1px solid rgba(0, 0, 0, 0.18);
			background: white;
			color: inherit;
			text-decoration: none;
			cursor: pointer;
		}

		.btn.primary {
			background: #111;
			border-color: #111;
			color: white;
		}

		.btn:disabled {
			opacity: 0.55;
			cursor: not-allowed;
		}

		.empty {
			border: 1px dashed rgba(0, 0, 0, 0.2);
			border-radius: 12px;
			padding: 18px;
			background: rgba(0, 0, 0, 0.02);
		}

		.hint {
			min-height: 18px;
			font-size: 12px;
			color: rgba(0, 0, 0, 0.7);
			margin: 0;
		}
	</style>
</Layout>
